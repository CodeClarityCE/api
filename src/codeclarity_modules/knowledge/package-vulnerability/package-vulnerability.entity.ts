import { ApiProperty } from "@nestjs/swagger";
import { Expose } from "class-transformer";
import {
  Entity,
  Column,
  PrimaryGeneratedColumn,
  Index,
  CreateDateColumn,
  ManyToOne,
  JoinColumn,
} from "typeorm";
import { FriendsOfPhp } from "../friendsofphp/friendsofphp.entity";
import { NVD } from "../nvd/nvd.entity";
import { OSV } from "../osv/osv.entity";

@Entity("package_vulnerability")
@Index(["packageName", "packageEcosystem"])
export class PackageVulnerability {
  @PrimaryGeneratedColumn("uuid")
  @ApiProperty()
  @Expose()
  id!: string;

  @Column({ name: "package_name" })
  @Index()
  @ApiProperty({
    description: "Package name (e.g., lodash, symfony/http-kernel)",
    example: "lodash",
  })
  @Expose()
  packageName!: string;

  @Column({ name: "package_ecosystem" })
  @Index()
  @ApiProperty({
    description: "Package ecosystem (npm, packagist)",
    example: "npm",
  })
  @Expose()
  packageEcosystem!: string;

  // FK to OSV table (nullable - exactly one of osv/nvd/friendsofphp must be set)
  @Column({ name: "osv_id", type: "uuid", nullable: true })
  @Index()
  @ApiProperty({
    description: "FK to OSV vulnerability record",
    required: false,
  })
  @Expose()
  osvId?: string;

  @ManyToOne(() => OSV, { nullable: true, onDelete: "CASCADE" })
  @JoinColumn({ name: "osv_id" })
  osv?: OSV;

  // FK to NVD table
  @Column({ name: "nvd_id", type: "uuid", nullable: true })
  @Index()
  @ApiProperty({
    description: "FK to NVD vulnerability record",
    required: false,
  })
  @Expose()
  nvdId?: string;

  @ManyToOne(() => NVD, { nullable: true, onDelete: "CASCADE" })
  @JoinColumn({ name: "nvd_id" })
  nvd?: NVD;

  // FK to FriendsOfPhp table
  @Column({ name: "friendsofphp_id", type: "uuid", nullable: true })
  @Index()
  @ApiProperty({
    description: "FK to FriendsOfPHP vulnerability record",
    required: false,
  })
  @Expose()
  friendsofphpId?: string;

  @ManyToOne(() => FriendsOfPhp, { nullable: true, onDelete: "CASCADE" })
  @JoinColumn({ name: "friendsofphp_id" })
  friendsofphp?: FriendsOfPhp;

  @CreateDateColumn({ name: "created_at" })
  @ApiProperty()
  @Expose()
  createdAt!: Date;
}
