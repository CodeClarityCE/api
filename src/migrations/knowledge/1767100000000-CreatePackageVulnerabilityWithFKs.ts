import { MigrationInterface, QueryRunner } from "typeorm";

export class CreatePackageVulnerabilityWithFKs1767100000000 implements MigrationInterface {
  name = "CreatePackageVulnerabilityWithFKs1767100000000";

  public async up(queryRunner: QueryRunner): Promise<void> {
    // Check if table already exists
    const tableExists = await queryRunner.query(`
      SELECT 1 FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name = 'package_vulnerability'
    `);

    if (tableExists && tableExists.length > 0) {
      return; // Table already exists, skip creation
    }

    // Check which source tables exist (they are created by Go knowledge service)
    const osvExists = await queryRunner.query(`
      SELECT 1 FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name = 'osv'
    `);
    const nvdExists = await queryRunner.query(`
      SELECT 1 FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name = 'nvd'
    `);
    const fopExists = await queryRunner.query(`
      SELECT 1 FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name = 'friends_of_php'
    `);

    // Build FK constraints only for tables that exist
    const fkConstraints: string[] = [];
    if (osvExists && osvExists.length > 0) {
      fkConstraints.push(
        `CONSTRAINT "FK_package_vulnerability_osv" FOREIGN KEY ("osv_id") REFERENCES "osv"("id") ON DELETE CASCADE`,
      );
    }
    if (nvdExists && nvdExists.length > 0) {
      fkConstraints.push(
        `CONSTRAINT "FK_package_vulnerability_nvd" FOREIGN KEY ("nvd_id") REFERENCES "nvd"("id") ON DELETE CASCADE`,
      );
    }
    if (fopExists && fopExists.length > 0) {
      fkConstraints.push(
        `CONSTRAINT "FK_package_vulnerability_friendsofphp" FOREIGN KEY ("friendsofphp_id") REFERENCES "friends_of_php"("id") ON DELETE CASCADE`,
      );
    }

    const fkClause =
      fkConstraints.length > 0
        ? `,\n        ${fkConstraints.join(",\n        ")}`
        : "";

    // Create the package_vulnerability table with FK columns
    await queryRunner.query(`
      CREATE TABLE "package_vulnerability" (
        "id" uuid NOT NULL DEFAULT uuid_generate_v4(),
        "package_name" character varying NOT NULL,
        "package_ecosystem" character varying NOT NULL,
        "osv_id" uuid,
        "nvd_id" uuid,
        "friendsofphp_id" uuid,
        "created_at" TIMESTAMP NOT NULL DEFAULT now(),
        CONSTRAINT "PK_package_vulnerability" PRIMARY KEY ("id"),
        CONSTRAINT "CHK_package_vulnerability_one_fk" CHECK (
          (("osv_id" IS NOT NULL)::int + ("nvd_id" IS NOT NULL)::int + ("friendsofphp_id" IS NOT NULL)::int) = 1
        )${fkClause}
      )
    `);

    // Create indexes for efficient lookups
    await queryRunner.query(
      `CREATE INDEX "IDX_pv_package_name" ON "package_vulnerability" ("package_name")`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_pv_package_ecosystem" ON "package_vulnerability" ("package_ecosystem")`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_pv_package_name_ecosystem" ON "package_vulnerability" ("package_name", "package_ecosystem")`,
    );

    // Partial indexes for FK columns (more efficient for nullable FKs)
    await queryRunner.query(
      `CREATE INDEX "IDX_pv_osv_id" ON "package_vulnerability" ("osv_id") WHERE "osv_id" IS NOT NULL`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_pv_nvd_id" ON "package_vulnerability" ("nvd_id") WHERE "nvd_id" IS NOT NULL`,
    );
    await queryRunner.query(
      `CREATE INDEX "IDX_pv_friendsofphp_id" ON "package_vulnerability" ("friendsofphp_id") WHERE "friendsofphp_id" IS NOT NULL`,
    );

    // Unique constraints per FK type (prevents duplicate package-vuln links)
    await queryRunner.query(
      `CREATE UNIQUE INDEX "IDX_pv_unique_osv" ON "package_vulnerability" ("package_name", "package_ecosystem", "osv_id") WHERE "osv_id" IS NOT NULL`,
    );
    await queryRunner.query(
      `CREATE UNIQUE INDEX "IDX_pv_unique_nvd" ON "package_vulnerability" ("package_name", "package_ecosystem", "nvd_id") WHERE "nvd_id" IS NOT NULL`,
    );
    await queryRunner.query(
      `CREATE UNIQUE INDEX "IDX_pv_unique_friendsofphp" ON "package_vulnerability" ("package_name", "package_ecosystem", "friendsofphp_id") WHERE "friendsofphp_id" IS NOT NULL`,
    );
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_unique_friendsofphp"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_unique_nvd"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_unique_osv"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_friendsofphp_id"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_nvd_id"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_osv_id"`);
    await queryRunner.query(
      `DROP INDEX "public"."IDX_pv_package_name_ecosystem"`,
    );
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_package_ecosystem"`);
    await queryRunner.query(`DROP INDEX "public"."IDX_pv_package_name"`);
    await queryRunner.query(`DROP TABLE "package_vulnerability"`);
  }
}
