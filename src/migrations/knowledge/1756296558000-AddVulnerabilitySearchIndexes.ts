import { MigrationInterface, QueryRunner } from "typeorm";

export class AddVulnerabilitySearchIndexes1756296558000 implements MigrationInterface {
  name = "AddVulnerabilitySearchIndexes1756296558000";

  public async up(queryRunner: QueryRunner): Promise<void> {
    // Create optimized indexes for vulnerability search performance

    // NVD table indexes
    await queryRunner.query(`
            CREATE INDEX IF NOT EXISTS "IDX_nvd_nvd_id_text_search" 
            ON "nvd" USING gin (to_tsvector('english', nvd_id))
        `);

    await queryRunner.query(`
            CREATE INDEX IF NOT EXISTS "IDX_nvd_descriptions_text_search" 
            ON "nvd" USING gin (to_tsvector('english', descriptions::text))
        `);

    // Additional NVD index for exact CVE matches (most common case)
    await queryRunner.query(`
            CREATE INDEX IF NOT EXISTS "IDX_nvd_nvd_id_upper" 
            ON "nvd" (upper(nvd_id))
        `);

    // OSV table indexes
    await queryRunner.query(`
            CREATE INDEX IF NOT EXISTS "IDX_osv_osv_id_upper" 
            ON "osv" (upper(osv_id))
        `);

    await queryRunner.query(`
            CREATE INDEX IF NOT EXISTS "IDX_osv_summary_text_search" 
            ON "osv" USING gin (to_tsvector('english', summary))
        `);

    // Enhanced aliases index with better performance for CVE searches
    await queryRunner.query(`
            CREATE INDEX IF NOT EXISTS "IDX_osv_aliases_gin" 
            ON "osv" USING gin (aliases)
        `);

    // Index for efficient NULL checks on aliases
    await queryRunner.query(`
            CREATE INDEX IF NOT EXISTS "IDX_osv_aliases_not_null" 
            ON "osv" (aliases) WHERE aliases IS NOT NULL
        `);
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    // Remove indexes in reverse order
    await queryRunner.query(`DROP INDEX IF EXISTS "IDX_osv_aliases_not_null"`);
    await queryRunner.query(`DROP INDEX IF EXISTS "IDX_osv_aliases_gin"`);
    await queryRunner.query(
      `DROP INDEX IF EXISTS "IDX_osv_summary_text_search"`,
    );
    await queryRunner.query(`DROP INDEX IF EXISTS "IDX_osv_osv_id_upper"`);
    await queryRunner.query(`DROP INDEX IF EXISTS "IDX_nvd_nvd_id_upper"`);
    await queryRunner.query(
      `DROP INDEX IF EXISTS "IDX_nvd_descriptions_text_search"`,
    );
    await queryRunner.query(
      `DROP INDEX IF EXISTS "IDX_nvd_nvd_id_text_search"`,
    );
  }
}
