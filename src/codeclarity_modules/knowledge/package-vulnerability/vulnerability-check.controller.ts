import { Body, Controller, Post } from "@nestjs/common";
import { ApiTags, ApiOperation, ApiResponse, ApiBody } from "@nestjs/swagger";
import { NonAuthEndpoint } from "src/decorators/SkipAuthDecorator";
import { VulnerabilityCheckService } from "./vulnerability-check.service";
import {
  VulnerabilityCheckRequestBody,
  VulnerabilityCheckResponse,
} from "./vulnerability-check.types";

@ApiTags("Knowledge - Packages")
@Controller("knowledge/packages")
export class VulnerabilityCheckController {
  constructor(
    private readonly vulnerabilityCheckService: VulnerabilityCheckService,
  ) {}

  @Post("check-vulnerabilities")
  @NonAuthEndpoint()
  @ApiOperation({
    summary: "Check multiple packages for known vulnerabilities",
    description:
      "Batch check packages against the knowledge database to find known vulnerabilities. Uses the package_vulnerability link table populated during OSV/NVD import. Supports npm and packagist ecosystems.",
  })
  @ApiBody({
    type: VulnerabilityCheckRequestBody,
    description: "Array of packages to check for vulnerabilities",
    examples: {
      npm: {
        summary: "NPM packages",
        value: {
          packages: [
            { name: "lodash", version: "4.17.0", ecosystem: "npm" },
            { name: "express", version: "4.17.0", ecosystem: "npm" },
          ],
        },
      },
      packagist: {
        summary: "Packagist packages",
        value: {
          packages: [
            {
              name: "symfony/http-kernel",
              version: "5.4.0",
              ecosystem: "packagist",
            },
            {
              name: "laravel/framework",
              version: "9.0.0",
              ecosystem: "packagist",
            },
          ],
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: "Vulnerability check results",
    type: VulnerabilityCheckResponse,
  })
  @ApiResponse({
    status: 400,
    description: "Bad request - invalid request body",
  })
  async checkVulnerabilities(
    @Body() request: VulnerabilityCheckRequestBody,
  ): Promise<VulnerabilityCheckResponse> {
    return await this.vulnerabilityCheckService.checkVulnerabilities(request);
  }
}
