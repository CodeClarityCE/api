import { MigrationInterface, QueryRunner } from 'typeorm';

export class AddPHPVulnerabilityIndexes1755452000000 implements MigrationInterface {
    name = 'AddPHPVulnerabilityIndexes1755452000000';

    public async up(queryRunner: QueryRunner): Promise<void> {
        // Create indexes to improve PHP vulnerability detection performance

        // 1. Index for FriendsOfPHP composer field for fast package lookups
        await queryRunner.query(
            `CREATE INDEX IF NOT EXISTS "idx_friends_of_php_composer" ON "friends_of_php" ("composer")`
        );

        // 2. Index for FriendsOfPHP advisory_id for fast ID lookups
        await queryRunner.query(
            `CREATE INDEX IF NOT EXISTS "idx_friends_of_php_advisory_id" ON "friends_of_php" ("advisory_id")`
        );

        // 3. Improve OSV affected field indexing for PURL-based queries (composer packages)
        // Use functional index for better performance on JSON queries
        await queryRunner.query(
            `CREATE INDEX IF NOT EXISTS "idx_osv_affected_purl_composer" ON "osv" USING gin (("affected"::jsonb))`
        );

        // 4. Index for NVD affected field for product matching
        await queryRunner.query(
            `CREATE INDEX IF NOT EXISTS "idx_nvd_affected_product" ON "nvd" USING gin (("affected"::jsonb))`
        );

        // 5. Create specific partial index for composer PURL patterns in OSV
        await queryRunner.query(
            `CREATE INDEX IF NOT EXISTS "idx_osv_composer_packages" ON "osv" USING gin ("affected") 
             WHERE "affected"::text LIKE '%pkg:composer/%'`
        );
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        // Drop the indexes that were created in the up method
        await queryRunner.query(`DROP INDEX IF EXISTS "idx_osv_composer_packages"`);
        await queryRunner.query(`DROP INDEX IF EXISTS "idx_nvd_affected_product"`);
        await queryRunner.query(`DROP INDEX IF EXISTS "idx_osv_affected_purl_composer"`);
        await queryRunner.query(`DROP INDEX IF EXISTS "idx_friends_of_php_advisory_id"`);
        await queryRunner.query(`DROP INDEX IF EXISTS "idx_friends_of_php_composer"`);
    }
}
