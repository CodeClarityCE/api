import { ApiProperty } from "@nestjs/swagger";
import { Expose, Type } from "class-transformer";
import {
  IsArray,
  IsEnum,
  IsNotEmpty,
  IsString,
  ValidateNested,
} from "class-validator";
import { PackageEcosystem } from "../package/outdated.types";

/********************************************/
/*             HTTP Post bodies             */
/********************************************/

export class VulnerabilityCheckPackageItem {
  @IsNotEmpty()
  @IsString()
  @ApiProperty({
    description: "Package name",
    example: "lodash",
  })
  name!: string;

  @IsNotEmpty()
  @IsString()
  @ApiProperty({
    description: "Current installed version",
    example: "4.17.0",
  })
  version!: string;

  @IsNotEmpty()
  @IsEnum(PackageEcosystem)
  @ApiProperty({
    description: "Package ecosystem",
    enum: PackageEcosystem,
    example: "npm",
  })
  ecosystem!: PackageEcosystem;
}

export class VulnerabilityCheckRequestBody {
  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => VulnerabilityCheckPackageItem)
  @ApiProperty({
    description: "Array of packages to check for vulnerabilities",
    type: [VulnerabilityCheckPackageItem],
  })
  packages!: VulnerabilityCheckPackageItem[];
}

/********************************************/
/*             Response types               */
/********************************************/

export class VulnerabilityInfo {
  @ApiProperty({
    description: "Vulnerability ID (GHSA-xxx, CVE-xxx)",
    example: "GHSA-35jh-r3h4-6jhm",
  })
  @Expose()
  vulnerabilityId!: string;

  @ApiProperty({
    description: "Associated CVE ID",
    example: "CVE-2021-23337",
    nullable: true,
  })
  @Expose()
  cveId?: string;

  @ApiProperty({
    description: "Severity level",
    example: "high",
  })
  @Expose()
  severity!: string;

  @ApiProperty({
    description: "CVSS score",
    example: 7.5,
    nullable: true,
  })
  @Expose()
  cvssScore?: number;

  @ApiProperty({
    description: "Brief summary of the vulnerability",
    example: "Prototype pollution in lodash",
  })
  @Expose()
  summary!: string;

  @ApiProperty({
    description: "Affected version ranges",
    example: '[{"introduced": "0", "fixed": "4.17.21"}]',
  })
  @Expose()
  affectedRanges!: string;

  @ApiProperty({
    description: "Version where the vulnerability was fixed",
    example: "4.17.21",
    nullable: true,
  })
  @Expose()
  fixedVersion?: string;

  @ApiProperty({
    description: "Source of vulnerability data",
    example: "osv",
  })
  @Expose()
  source!: string;
}

export class PackageVulnerabilityResult {
  @ApiProperty({
    description: "Package name",
    example: "lodash",
  })
  @Expose()
  packageName!: string;

  @ApiProperty({
    description: "Package version that was checked",
    example: "4.17.0",
  })
  @Expose()
  packageVersion!: string;

  @ApiProperty({
    description: "Package ecosystem",
    enum: PackageEcosystem,
    example: "npm",
  })
  @Expose()
  ecosystem!: PackageEcosystem;

  @ApiProperty({
    description: "Whether the package version is vulnerable",
    example: true,
  })
  @Expose()
  isVulnerable!: boolean;

  @ApiProperty({
    description: "List of vulnerabilities affecting this package version",
    type: [VulnerabilityInfo],
  })
  @Expose()
  vulnerabilities!: VulnerabilityInfo[];
}

export class VulnerabilityCheckResponse {
  @ApiProperty({
    description: "Array of package vulnerability check results",
    type: [PackageVulnerabilityResult],
  })
  @Expose()
  packages!: PackageVulnerabilityResult[];

  @ApiProperty({
    description: "Total number of vulnerabilities found",
    example: 3,
  })
  @Expose()
  totalVulnerabilities!: number;

  @ApiProperty({
    description: "Timestamp when the check was performed",
    example: "2024-01-15T10:30:00.000Z",
  })
  @Expose()
  checkedAt!: string;
}
